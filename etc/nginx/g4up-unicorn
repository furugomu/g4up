upstream g4up-unicorn {
    server unix:/var/rails/g4up/current/tmp/sockets/unicorn.sock;
}

server {
    listen 80;
    server_name g4up.precog.net;

    # TODO rotate
    access_log /var/rails/g4up/current/log/nginx.access.log;
    error_log /var/rails/g4up/current/log/nginx.error.log;

    root /var/rails/g4up/current/public;

    try_files $uri/index.html $uri.html $uri @app;

    location @app {
        index index.html index.htm;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_redirect off;
        proxy_pass http://g4up-unicorn;
    }

    # リファラー無しで full に来たら画像だけ表示
    location ~ ^/entries/([0-9]+)/full/.+\.jpg$ {
        set $id $1;
        if ($http_referer = "") {
            rewrite ^ /system/photos/$id/original/g4u$id.jpg last;
        }
        try_files $uri @app;
    }

    # たんしゅくURL
    #location ~ ^/g4u([0-9]+)\.jpg$ {
    #    set $id $1;
    #    rewrite ^ /entries/$id/full/g4u$id.jpg redirect;
    #}

    # ローカルから消した画像は ec2 へ
    location ~ ^/system/photos/(.+) {
        try_files $uri http://s3-ap-northeast-1.amazonaws.com/g4u/photo/$1;
    }
}

